@page
@model Car_Agency_Management.Pages.rentModel
@using Car_Agency_Management.Data
@{
    ViewData["Title"] = "Schedule Your Rent";
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Your Rent - Car Agency</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0 !important;
            padding: 0 !important;
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.03) 0%, rgba(14, 165, 233, 0.05) 100%);
            min-height: 100vh;
            padding-top: 100px;
            position: relative;
            overflow-x: hidden;
        }

            body::before,
            body::after {
                content: '';
                position: fixed;
                border-radius: 50%;
                pointer-events: none;
                z-index: 0;
            }

            body::before {
                width: 600px;
                height: 600px;
                background: radial-gradient(circle, rgba(6, 182, 212, 0.1), transparent 70%);
                top: -300px;
                right: -300px;
                animation: floatCircle1 20s ease-in-out infinite;
            }

            body::after {
                width: 500px;
                height: 500px;
                background: radial-gradient(circle, rgba(30, 41, 59, 0.08), transparent 70%);
                bottom: -250px;
                left: -250px;
                animation: floatCircle2 18s ease-in-out infinite;
            }

        @@keyframes floatCircle1 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }

            25% {
                transform: translate(-100px, 150px) scale(1.1);
            }

            50% {
                transform: translate(-50px, 300px) scale(0.9);
            }

            75% {
                transform: translate(50px, 200px) scale(1.05);
            }
        }

        @@keyframes floatCircle2 {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }

            25% {
                transform: translate(150px, -100px) scale(1.15);
            }

            50% {
                transform: translate(100px, -50px) scale(0.85);
            }

            75% {
                transform: translate(50px, -150px) scale(1.1);
            }
        }

        .floating-shape {
            position: fixed;
            border-radius: 50%;
            opacity: 0.1;
            pointer-events: none;
            animation: float 20s infinite ease-in-out;
            z-index: 0;
        }

        .shape-1 {
            width: 300px;
            height: 300px;
            background: #06b6d4;
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }

        .shape-2 {
            width: 200px;
            height: 200px;
            background: #1e293b;
            top: 60%;
            right: 10%;
            animation-delay: 3s;
        }

        .shape-3 {
            width: 150px;
            height: 150px;
            background: #06b6d4;
            bottom: 20%;
            left: 15%;
            animation-delay: 6s;
        }

        @@keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0) rotate(0deg);
            }

            33% {
                transform: translateY(-30px) translateX(20px) rotate(120deg);
            }

            66% {
                transform: translateY(20px) translateX(-30px) rotate(240deg);
            }
        }

        .page-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        .page-title {
            font-size: 32px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 10px;
        }

        .page-subtitle {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 20px;
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        @@media (max-width: 992px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        .calendar-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

            .calendar-container:hover {
                transform: translateY(-5px);
            }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

            .calendar-header button {
                background: none;
                border: none;
                font-size: 18px;
                cursor: pointer;
                color: #6c757d;
                padding: 5px 10px;
                transition: color 0.3s;
            }

                .calendar-header button:hover {
                    color: #212529;
                }

        .calendar-month {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .calendar-day-header {
            font-size: 12px;
            font-weight: 600;
            color: #6c757d;
            padding: 10px 5px;
        }

        .calendar-day {
            padding: 12px 5px;
            font-size: 14px;
            color: #212529;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            position: relative;
        }

            .calendar-day:hover:not(.disabled):not(.booked) {
                background-color: #e7f3ff;
                color: #0066cc;
            }

            .calendar-day.selected {
                background-color: #0066cc;
                color: white;
                font-weight: 600;
            }

            .calendar-day.disabled {
                color: #dee2e6;
                cursor: not-allowed;
            }

            .calendar-day.booked {
                background-color: #ffe0e0;
                color: #dc3545;
                cursor: not-allowed;
                text-decoration: line-through;
            }

            .calendar-day.in-range {
                background-color: #e7f3ff;
                color: #0066cc;
            }

        .info-box {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: transform 0.3s ease;
        }

            .info-box:hover {
                transform: translateY(-5px);
            }

        .info-text {
            font-size: 14px;
            color: #6c757d;
            line-height: 1.6;
        }

        .info-highlight {
            font-size: 16px;
            font-weight: 600;
            color: #212529;
            margin-top: 15px;
        }

        .next-button-container {
            display: flex;
            justify-content: flex-end;
        }

        .next-button {
            background-color: #212529;
            color: white;
            border: none;
            padding: 12px 40px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

            .next-button:hover {
                background-color: #0066cc;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,102,204,0.3);
            }

            .next-button:disabled {
                background-color: #6c757d;
                cursor: not-allowed;
                transform: none;
            }

        .date-inputs {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .date-input-group {
            flex: 1;
        }

            .date-input-group label {
                display: block;
                font-size: 13px;
                color: #6c757d;
                margin-bottom: 5px;
                font-weight: 500;
            }

            .date-input-group input {
                width: 100%;
                padding: 10px;
                border: 1px solid #dee2e6;
                border-radius: 6px;
                font-size: 14px;
                transition: border-color 0.3s;
            }

                .date-input-group input:focus {
                    outline: none;
                    border-color: #0066cc;
                }

        .alert-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d1f4e0;
            color: #0f5132;
            border: 1px solid #a3e4b8;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #842029;
            border: 1px solid #f5c2c7;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #997404;
            border: 1px solid #ffe69c;
        }
    </style>
</head>
<body>
    <div class="floating-shape shape-1"></div>
    <div class="floating-shape shape-2"></div>
    <div class="floating-shape shape-3"></div>

    <div class="page-container">
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert-message alert-error">
                @TempData["ErrorMessage"]
            </div>
        }

        @if (Model.IsCheckingAvailability)
        {
            if (Model.IsAvailable)
            {
                <div class="alert-message alert-success">
                    ✅ @Model.AvailabilityMessage - Estimated cost: EGP @Model.EstimatedCost.ToString("N2") for @Model.RentalDays day(s)
                </div>
            }
            else
            {
                <div class="alert-message alert-error">
                    ❌ @Model.AvailabilityMessage
                </div>
            }
        }

        <h1 class="page-title">Schedule your Rent</h1>
        <p class="page-subtitle">
            @if (Model.CarInfo != null)
            {
                <span>Booking: <strong>@Model.CarInfo.CarName</strong> - Check availability and select your rental dates</span>
            }
            else
            {
                <span>Check out our availability and book the start date and end date</span>
            }
        </p>

        <form method="post">
            <input type="hidden" name="carId" value="@Model.CarId" />
            <input type="hidden" id="startDateHidden" name="startDate" />
            <input type="hidden" id="endDateHidden" name="endDate" />

            <div class="content-grid">
                <!-- Date and Time Selection -->
                <div>
                    <h3 class="section-title">Select a Date and Time</h3>
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button type="button" onclick="previousMonth()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="calendar-month" id="currentMonth">December 2025</div>
                            <button type="button" onclick="nextMonth()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="calendar-days" id="calendarDays">
                            <div class="calendar-day-header">Sun</div>
                            <div class="calendar-day-header">Mon</div>
                            <div class="calendar-day-header">Tue</div>
                            <div class="calendar-day-header">Wed</div>
                            <div class="calendar-day-header">Thu</div>
                            <div class="calendar-day-header">Fri</div>
                            <div class="calendar-day-header">Sat</div>
                        </div>
                        <div class="date-inputs">
                            <div class="date-input-group">
                                <label>Start Date</label>
                                <input type="date" id="startDateInput" onchange="updateFromInput()">
                            </div>
                            <div class="date-input-group">
                                <label>End Date</label>
                                <input type="date" id="endDateInput" onchange="updateFromInput()">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Car Availability -->
                <div>
                    <h3 class="section-title">Car Availability</h3>
                    <div class="info-box">
                        <div class="info-text">
                            Selected start date
                        </div>
                        <div class="info-highlight" id="availabilityDate">Please select dates</div>
                    </div>
                </div>

                <!-- Service Details -->
                <div>
                    <h3 class="section-title">Service Details</h3>
                    <div class="info-box">
                        <div class="info-text">
                            Rent
                        </div>
                        <div class="info-highlight" id="serviceDetails">
                            @if (Model.CarInfo != null)
                            {
                                <span>@Model.CarInfo.CarName</span>
                            }
                            else
                            {
                                <span>Select dates to see details</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <div class="next-button-container">
                <button type="button" class="next-button" id="checkButton" onclick="checkAvailability()" style="margin-right: 10px; background-color: #6c757d;" disabled>
                    Check Availability
                </button>
                <button type="submit" class="next-button" id="nextButton" formaction="?handler=ProceedToPayment" disabled>
                    Next
                </button>
            </div>
        </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration from backend - NO JSON!
        const carId = @Model.CarId;
        let bookedDateRanges = [
            @if (Model.BookedDates != null && Model.BookedDates.Count > 0)
            {
                    for (int i = 0; i < Model.BookedDates.Count; i++)
                    {
                            <text>
                            {
                                startDate: '@Model.BookedDates[i].StartDate.ToString("yyyy-MM-dd")',
                                endDate: '@Model.BookedDates[i].EndDate.ToString("yyyy-MM-dd")'
                            }@(i < Model.BookedDates.Count - 1 ? "," : "")
                            </text>
                    }
            }
        ];

        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedStartDate = null;
        let selectedEndDate = null;

        // Check if a date is booked
        function isDateBooked(date) {
            for (let range of bookedDateRanges) {
                const start = new Date(range.startDate);
                const end = new Date(range.endDate);
                if (date >= start && date <= end) {
                    return true;
                }
            }
            return false;
        }

        function generateCalendar() {
            const calendarDays = document.getElementById('calendarDays');
            const headers = calendarDays.querySelectorAll('.calendar-day-header');
            calendarDays.innerHTML = '';
            headers.forEach(h => calendarDays.appendChild(h));

            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day disabled';
                calendarDays.appendChild(emptyDay);
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                const currentDate = new Date(currentYear, currentMonth, day);

                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                dayElement.setAttribute('data-day', day);
                dayElement.setAttribute('data-month', currentMonth);
                dayElement.setAttribute('data-year', currentYear);

                // Disable past dates
                if (currentDate < today) {
                    dayElement.classList.add('disabled');
                }
                // Mark booked dates
                else if (isDateBooked(currentDate)) {
                    dayElement.classList.add('booked');
                    dayElement.title = 'This date is already booked';
                }
                else {
                    dayElement.onclick = function() { selectDate(this); };
                }

                calendarDays.appendChild(dayElement);
            }
        }

        function selectDate(element) {
            if (element.classList.contains('disabled') || element.classList.contains('booked')) {
                return;
            }

            const day = parseInt(element.getAttribute('data-day'));
            const month = parseInt(element.getAttribute('data-month'));
            const year = parseInt(element.getAttribute('data-year'));
            const selectedDate = new Date(year, month, day);

            if (!selectedStartDate) {
                // Select start date
                document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected', 'in-range'));
                element.classList.add('selected');
                selectedStartDate = selectedDate;
                document.getElementById('startDateInput').valueAsDate = selectedDate;
                updateAvailability();
                document.getElementById('checkButton').disabled = true;
                document.getElementById('nextButton').disabled = true;
            } else if (!selectedEndDate) {
                // Select end date
                if (selectedDate > selectedStartDate) {
                    // Check if any dates in range are booked
                    let rangeBlocked = false;
                    for (let d = new Date(selectedStartDate); d <= selectedDate; d.setDate(d.getDate() + 1)) {
                        if (isDateBooked(new Date(d))) {
                            rangeBlocked = true;
                            break;
                        }
                    }

                    if (rangeBlocked) {
                        Swal.fire({
                            title: 'Dates Blocked',
                            text: 'Selected date range contains booked dates. Please choose different dates.',
                            icon: 'error'
                        });
                        return;
                    }

                    selectedEndDate = selectedDate;
                    element.classList.add('selected');
                    document.getElementById('endDateInput').valueAsDate = selectedDate;
                    highlightRange();
                    updateServiceDetails();
                    document.getElementById('checkButton').disabled = false;
                    document.getElementById('checkButton').style.backgroundColor = '#0066cc';
                } else {
                    Swal.fire({
                        title: 'Invalid Date Range',
                        text: 'End date must be after start date.',
                        icon: 'info'
                    });
                }
            } else {
                // Reset and start over
                document.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected', 'in-range'));
                element.classList.add('selected');
                selectedStartDate = selectedDate;
                selectedEndDate = null;
                document.getElementById('startDateInput').valueAsDate = selectedDate;
                document.getElementById('endDateInput').value = '';
                updateAvailability();
                document.getElementById('serviceDetails').innerHTML = '@Model.CarInfo?.CarName';
                document.getElementById('checkButton').disabled = true;
                document.getElementById('checkButton').style.backgroundColor = '#6c757d';
                document.getElementById('nextButton').disabled = true;
            }
        }

        function highlightRange() {
            document.querySelectorAll('.calendar-day').forEach(day => {
                if (day.classList.contains('disabled') || day.classList.contains('booked')) return;
                const dayNum = parseInt(day.getAttribute('data-day'));
                const monthNum = parseInt(day.getAttribute('data-month'));
                const yearNum = parseInt(day.getAttribute('data-year'));
                if (!dayNum) return;

                const dayDate = new Date(yearNum, monthNum, dayNum);
                if (dayDate > selectedStartDate && dayDate < selectedEndDate) {
                    day.classList.add('in-range');
                }
            });
        }

        function updateAvailability() {
            if (selectedStartDate) {
                const year = selectedStartDate.getFullYear();
                const month = String(selectedStartDate.getMonth() + 1).padStart(2, '0');
                const day = String(selectedStartDate.getDate()).padStart(2, '0');
                document.getElementById('availabilityDate').textContent = `${day}/${month}/${year}`;
            }
        }

        function updateServiceDetails() {
            if (selectedStartDate && selectedEndDate) {
                const days = Math.ceil((selectedEndDate - selectedStartDate) / (1000 * 60 * 60 * 24));
                const carName = '@Model.CarInfo?.CarName' || 'Car Rental';
                document.getElementById('serviceDetails').textContent = `${carName} for ${days} day(s)`;
            }
        }

        function updateFromInput() {
            const startInput = document.getElementById('startDateInput').value;
            const endInput = document.getElementById('endDateInput').value;

            if (startInput) {
                selectedStartDate = new Date(startInput);
                selectedStartDate.setHours(0, 0, 0, 0);
                updateAvailability();
            }

            if (endInput) {
                selectedEndDate = new Date(endInput);
                selectedEndDate.setHours(0, 0, 0, 0);

                if (selectedStartDate && selectedEndDate > selectedStartDate) {
                    generateCalendar();
                    highlightCalendarFromInputs();
                    updateServiceDetails();
                    document.getElementById('checkButton').disabled = false;
                    document.getElementById('checkButton').style.backgroundColor = '#0066cc';
                } else if (selectedStartDate) {
                    Swal.fire({
                        title: 'Invalid Date Range',
                        text: 'End date must be after start date.',
                        icon: 'info'
                    });
                    document.getElementById('endDateInput').value = '';
                    selectedEndDate = null;
                }
            }
        }

        function highlightCalendarFromInputs() {
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected', 'in-range');
                if (day.classList.contains('disabled') || day.classList.contains('booked')) return;

                const dayNum = parseInt(day.getAttribute('data-day'));
                const monthNum = parseInt(day.getAttribute('data-month'));
                const yearNum = parseInt(day.getAttribute('data-year'));
                if (!dayNum) return;

                const dayDate = new Date(yearNum, monthNum, dayNum);
                dayDate.setHours(0, 0, 0, 0);

                if (selectedStartDate && dayDate.getTime() === selectedStartDate.getTime()) {
                    day.classList.add('selected');
                }
                if (selectedEndDate && dayDate.getTime() === selectedEndDate.getTime()) {
                    day.classList.add('selected');
                }
                if (selectedStartDate && selectedEndDate && dayDate > selectedStartDate && dayDate < selectedEndDate) {
                    day.classList.add('in-range');
                }
            });
        }

        function previousMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendarDisplay();
            generateCalendar();
            if (selectedStartDate && selectedEndDate) {
                highlightCalendarFromInputs();
            }
        }

        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendarDisplay();
            generateCalendar();
            if (selectedStartDate && selectedEndDate) {
                highlightCalendarFromInputs();
            }
        }

        function updateCalendarDisplay() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent = `${months[currentMonth]} ${currentYear}`;
        }

        function checkAvailability() {
            if (!selectedStartDate || !selectedEndDate) {
                Swal.fire({
                    title: 'Dates Required',
                    text: 'Please select both start and end dates to check availability.',
                    icon: 'info'
                });
                return;
            }

            // Update hidden form fields
            // Use local date components manually to avoid timezone shifts from toISOString()
            const startYear = selectedStartDate.getFullYear();
            const startMonth = String(selectedStartDate.getMonth() + 1).padStart(2, '0');
            const startDay = String(selectedStartDate.getDate()).padStart(2, '0');
            document.getElementById('startDateHidden').value = `${startYear}-${startMonth}-${startDay}`;

            const endYear = selectedEndDate.getFullYear();
            const endMonth = String(selectedEndDate.getMonth() + 1).padStart(2, '0');
            const endDay = String(selectedEndDate.getDate()).padStart(2, '0');
            document.getElementById('endDateHidden').value = `${endYear}-${endMonth}-${endDay}`;

            // Submit form to check availability
            document.querySelector('form').submit();
        }

        // Initialize calendar on page load
        updateCalendarDisplay();
        generateCalendar();

        // Restore selected dates if page was posted back
        @if (Model.IsCheckingAvailability)
        {
                <text>
                // Restore dates from the check
                const savedStartDate = '@Request.Form["startDate"]';
                const savedEndDate = '@Request.Form["endDate"]';

                if (savedStartDate && savedEndDate) {
                    selectedStartDate = new Date(savedStartDate);
                    selectedEndDate = new Date(savedEndDate);

                    document.getElementById('startDateInput').value = savedStartDate;
                    document.getElementById('endDateInput').value = savedEndDate;
                    document.getElementById('startDateHidden').value = savedStartDate;
                    document.getElementById('endDateHidden').value = savedEndDate;

                    updateAvailability();
                    updateServiceDetails();
                    highlightCalendarFromInputs();

                    document.getElementById('checkButton').disabled = false;
                    document.getElementById('checkButton').style.backgroundColor = '#0066cc';

                    @if (Model.IsAvailable)
                    {
                            <text>
                            // Enable next button if available
                            document.getElementById('nextButton').disabled = false;
                            </text>
                    }
                }
                </text>
        }
    </script>
</body>
</html>